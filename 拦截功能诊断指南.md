# 拦截功能问题诊断指南

## 新 APK 信息
- **构建时间**: 2026-01-06 11:16
- **文件**: `app/build/outputs/apk/debug/app-debug.apk`
- **MD5**: 34ec0046f8a9a88fccec0c443d5e2f7a
- **文件大小**: 12MB

## 安装前的准备

### 1. 完全卸载旧版本
```bash
# 通过 adb 卸载
adb uninstall com.timebank.app

# 或者在手机上手动卸载：
# 设置 -> 应用 -> 时间银行 -> 卸载
```

### 2. 安装新版本
```bash
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

注意：使用 `-r` 参数会替换安装，但还是建议先完全卸载。

## 拦截功能测试步骤

### 第一步：配置权限（必须！）

1. **开启使用情况访问权限**
   - 打开时间银行 App
   - 点击主页的"开启使用情况访问权限"按钮
   - 在系统设置中找到"时间银行"
   - 打开权限开关
   - **验证**: 返回 App，应该显示"开启悬浮窗权限"提示

2. **开启悬浮窗权限**（拦截功能必需！）
   - 点击"开启悬浮窗权限"按钮
   - 在系统设置中找到"时间银行"
   - 打开"显示悬浮窗"或"显示在其他应用上层"权限
   - **验证**: 返回 App，应该显示"✅ 所有权限已开启"

### 第二步：配置应用分类

1. **切换到"分类"页面**
2. **添加一个负向应用**（建议使用容易打开的应用）
   - 推荐测试应用：Chrome、微信、抖音等
   - 在"未分类"列表中找到目标应用
   - 点击"负向"按钮
   - **验证**: 应用出现在"负向应用"列表中

### 第三步：设置余额为 0

1. **切换到"设置"页面**
2. **点击"重置余额"**
3. **在弹出的对话框中点击"确认"**
4. **验证**: "当前余额"显示为"0小时 0分钟"

### 第四步：开启监控服务

1. **在"设置"页面**
2. **打开"后台监控服务"开关**
3. **验证**:
   - 通知栏显示"时间银行正在运行"
   - 开关没有闪退，保持开启状态

### 第五步：测试拦截（关键！）

1. **切换到主页或退出 App**
2. **尝试打开之前设置的负向应用**
3. **预期行为**:
   - 负向应用启动画面出现
   - **立即**（1秒内）被全屏拦截界面覆盖
   - 拦截界面显示：
     - "⚠️ 时间余额不足"
     - "无法打开 [应用名称]"
     - "当前余额: 0小时 0分钟"
4. **点击"我知道了"关闭拦截界面**
5. **再次尝试打开相同的负向应用**
6. **预期**: 再次被拦截（持续拦截）

## 可能的问题和解决方案

### 问题 1: 拦截界面没有弹出

**可能原因和检查方法**:

#### 原因 A: 悬浮窗权限未开启
- **检查方法**:
  - 进入系统设置 -> 应用 -> 时间银行 -> 权限
  - 查看"显示悬浮窗"或"显示在其他应用上层"是否开启
- **解决方案**: 开启悬浮窗权限

#### 原因 B: 监控服务未运行
- **检查方法**:
  - 查看通知栏是否有"时间银行正在运行"
  - 进入设置页面，查看监控服务开关是否打开
- **解决方案**: 在设置页面打开监控服务

#### 原因 C: 余额不是 0
- **检查方法**:
  - 进入设置页面
  - 查看"当前余额"是否为"0小时 0分钟"
- **解决方案**: 点击"重置余额"

#### 原因 D: 应用未正确分类
- **检查方法**:
  - 进入分类页面
  - 切换到"负向应用"标签
  - 查看目标应用是否在列表中
- **解决方案**: 重新添加应用到负向分类

#### 原因 E: 系统杀掉了后台服务
- **检查方法**:
  - 打开负向应用后立即查看通知栏
  - 如果"时间银行正在运行"通知消失了，说明服务被杀
- **解决方案**:
  - 进入系统设置 -> 电池 -> 时间银行 -> 无限制
  - 进入系统设置 -> 应用 -> 时间银行 -> 自启动（允许）

### 问题 2: 拦截延迟超过 1 秒

**可能原因**:
- 设备性能问题
- 后台服务被限制

**检查方法**:
```bash
# 查看日志
adb logcat -s MonitorService | grep "拦截"
```

**预期日志**:
```
D/MonitorService: 切换到应用: com.android.chrome
D/MonitorService: 检测到打开负向应用 Chrome，但余额为0，立即拦截
```

### 问题 3: 点击"我知道了"后可以继续使用

**这不是 Bug！** 这是 Android 系统限制：
- 拦截界面是一个独立的 Activity
- 用户关闭后，原应用会恢复到前台
- MonitorService 会在下一次检查（1秒后）再次拦截
- **持续拦截机制**: 每次检测到负向应用都会拦截

**如果真的可以持续使用**:
- 检查监控服务是否还在运行（查看通知栏）
- 可能是系统杀掉了服务

### 问题 4: 开启监控服务闪退

**已修复！** 如果仍然闪退：
- **确认已安装最新 APK**（11:16 构建）
- **查看崩溃日志**:
```bash
adb logcat | grep -E "FATAL|AndroidRuntime"
```

## 详细日志调试

### 启用详细日志
```bash
# 实时查看所有相关日志
adb logcat -s MonitorService SettingsScreen ClassifyScreen

# 仅查看拦截相关
adb logcat | grep -E "拦截|余额|BlockActivity"

# 查看服务生命周期
adb logcat | grep "MonitorService"
```

### 关键日志检查点

#### 1. 服务启动
```
D/SettingsScreen: 启动监控服务
D/MonitorService: 服务创建
D/MonitorService: 服务启动
```

#### 2. 检测到切换应用
```
D/MonitorService: 切换到应用: com.android.chrome
```

#### 3. 拦截触发（余额为 0）
```
D/MonitorService: 检测到打开负向应用 Chrome，但余额为0，立即拦截
```

#### 4. 如果没有这条日志，可能的原因：
- 应用包名不匹配（检查日志中显示的包名）
- 应用未分类或分类错误
- 余额不是 0

### 获取应用包名
```bash
# 方法 1: 打开应用后运行
adb shell dumpsys window | grep -E 'mCurrentFocus|mFocusedApp'

# 方法 2: 列出所有已安装应用
adb shell pm list packages

# 方法 3: 在 App 的日志中查看
adb logcat -s MonitorService | grep "切换到应用"
```

## 完整测试流程（录屏建议）

建议录制屏幕，完整执行以下流程：

1. **卸载旧版本**
2. **安装新 APK**（11:16 版本）
3. **打开 App，开启所有权限**
4. **添加负向应用**（如 Chrome）
5. **重置余额为 0**
6. **开启监控服务**
7. **退出 App**
8. **打开负向应用**
9. **观察是否立即弹出拦截界面**
10. **关闭拦截界面**
11. **再次打开负向应用**
12. **观察是否继续拦截**

## 如果所有步骤都正确但仍不工作

请提供以下信息：

1. **设备信息**:
   - 手机型号
   - Android 版本
   - 系统 UI（MIUI/EMUI/ColorOS 等）

2. **权限截图**:
   - 使用情况访问权限页面
   - 悬浮窗权限页面

3. **日志输出**:
```bash
# 复制以下完整日志
adb logcat -s MonitorService SettingsScreen ClassifyScreen > timebank.log
# 执行测试流程
# Ctrl+C 停止
# 发送 timebank.log 文件
```

4. **测试步骤记录**:
   - 余额是多少
   - 监控服务是否开启
   - 测试的是哪个应用
   - 发生了什么（或没发生什么）

---

**维护者**: Claude Code
**更新时间**: 2026-01-06 11:16
**版本**: v1.1 (第二次构建)
