# 时间银行 - 第三次修复和详细测试指南

**构建时间**: 2026-01-06 11:30+
**设备**: 三星 S24U Android 16
**APK**: `app/build/outputs/apk/debug/app-debug.apk`

## 本次修复内容

### 1. 前台服务权限（Android 14+）
- 添加 `FOREGROUND_SERVICE_DATA_SYNC` 权限（Android 14+ 必需）

### 2. 服务启动闪退修复
- 使用 `rememberCoroutineScope` + 延迟 100ms 更新状态
- 避免状态更新导致的重组中断服务启动

### 3. 拦截逻辑优化
- 不更新 `lastApp` 和 `lastCheckTime`，确保持续拦截
- 添加详细日志输出，便于诊断

### 4. 应用列表修复
- 使用 `SharingStarted.Eagerly` 确保数据流不被中断

## 安装步骤

###步骤 1: 完全卸载旧版本

**方法 A - 通过 ADB (推荐)**:
```bash
adb uninstall com.timebank.app
```

**方法 B - 手动卸载**:
1. 设置 -> 应用 -> 时间银行
2. 卸载

### 步骤 2: 安装新版本

```bash
cd /Users/wj/AndroidStudioProjects/MyApplication
adb install app/build/outputs/apk/debug/app-debug.apk
```

## 详细测试流程（带日志监控）

### 准备工作：启动日志监控

打开一个终端窗口，运行：

```bash
# 监控所有相关日志
adb logcat -s MonitorService SettingsScreen ClassifyScreen

# 或者保存到文件
adb logcat -s MonitorService SettingsScreen ClassifyScreen > timebank-test.log
```

保持这个窗口打开，在执行测试时观察日志输出。

---

### 测试 1: 权限配置

#### 操作步骤：
1. 打开"时间银行" App
2. 主页应显示"⚠️ 需要开启使用情况访问权限"
3. 点击"开启使用情况访问权限"按钮
4. 在系统设置中找到"时间银行"并开启
5. 返回 App

#### 预期日志：
```
(此时还没有日志，因为服务未启动)
```

#### 预期界面：
- 主页显示"⚠️ 需要开启悬浮窗权限"

#### 继续操作：
6. 点击"开启悬浮窗权限"按钮
7. 在系统设置中找到"时间银行"
8. 开启"显示在其他应用上层"或"悬浮窗"权限
9. 返回 App

#### 预期界面：
- 主页显示"✅ 所有权限已开启"

---

### 测试 2: 应用分类

#### 操作步骤：
1. 切换到"分类"Tab
2. 切换到"未分类"子页面

#### 预期界面：
- 显示已安装应用列表（不是空的）
- 每个应用显示图标、名称、包名
- 有"正向"和"负向"两个按钮

#### 预期日志：
```
D/ClassifyViewModel: 已加载 XXX 个应用
D/ClassifyViewModel: combine: installed=XXX, classified=0
D/ClassifyViewModel: 未分类应用数量: XXX
```

#### 继续操作：
3. 找一个常用应用（如 Chrome: com.android.chrome）
4. 点击"负向"按钮
5. 切换到"负向应用"子页面

#### 预期界面：
- 显示刚添加的应用
- 切换回"未分类"，该应用不再显示

---

### 测试 3: 监控服务启动

#### 操作步骤：
1. 切换到"设置"Tab
2. 查看"后台监控服务"开关状态（应该是关闭）
3. 点击开关，开启服务

#### 预期日志：
```
D/SettingsScreen: 启动监控服务
D/MonitorService: 服务创建
D/MonitorService: 服务启动
D/MonitorService: 检查前台应用: com.timebank.app (上次: null)
```

#### 预期界面：
- 开关变为"开启"状态
- **不应闪退！**
- 通知栏显示"时间银行正在运行"

#### 压力测试：
4. 快速点击开关 5-10 次（开-关-开-关...）

#### 预期：
- **不应闪退！**
- 日志中应看到多次"启动"和"停止"
- 最终状态与开关一致

---

### 测试 4: 余额重置

#### 操作步骤：
1. 在"设置"Tab
2. 点击"重置余额"卡片
3. 在弹出的对话框中点击"确认"

#### 预期界面：
- "当前余额"显示"0小时 0分钟"

---

### 测试 5: 拦截功能（核心测试！）

#### 操作步骤：
1. 确认：
   - 监控服务已开启（通知栏有提示）
   - 余额为 0
   - 已添加至少一个负向应用
2. 按Home键或返回桌面
3. 尝试打开负向应用（如 Chrome）

#### 预期日志（关键！）：
```
D/MonitorService: 检查前台应用: com.android.chrome (上次: com.timebank.app)
D/MonitorService: 检测到切换到新应用: com.android.chrome
D/MonitorService: 应用分类: Chrome - NEGATIVE
D/MonitorService: 负向应用，当前余额: 0
D/MonitorService: 余额不足，立即拦截负向应用: Chrome
```

#### 预期界面：
- Chrome 的启动画面短暂出现（<1秒）
- **立即**弹出全屏拦截界面：
  - 显示"⚠️ 时间余额不足"
  - 显示"无法打开 Chrome"
  - 显示"当前余额: 0小时 0分钟"
  - 显示"💡 如何获得时间余额？"提示
  - 有"我知道了"按钮

#### 继续操作：
4. 点击"我知道了"关闭拦截界面
5. 立即再次尝试打开 Chrome

#### 预期：
- 再次被拦截（持续拦截）
- 日志中再次看到拦截信息

---

### 测试 6: 正向应用获得时间

#### 操作步骤：
1. 在"分类"页面添加一个正向应用（如某个学习类App）
2. 确认兑换比例为 1.0（设置页面）
3. 确认监控服务已开启
4. 打开正向应用，使用 10 秒以上
5. 返回"时间银行"

#### 预期日志：
```
D/MonitorService: 检查前台应用: com.example.studyapp (上次: com.timebank.app)
D/MonitorService: 检测到切换到新应用: com.example.studyapp
D/MonitorService: 应用分类: Study App - POSITIVE
D/MonitorService: 同一应用 com.example.studyapp 使用了 1 秒
D/MonitorService: 正向应用 Study App 使用 1秒，获得 1秒
(重复多次)
```

#### 预期界面：
- "设置"页面的"当前余额"增加约 10 秒
- 主页的"当前余额"也相应增加

---

### 测试 7: 负向应用扣除时间（余额充足）

#### 操作步骤：
1. 确认余额 > 0（如刚才获得的 10 秒）
2. 打开负向应用（如 Chrome）
3. 使用 5 秒
4. 返回"时间银行"

#### 预期日志：
```
D/MonitorService: 检查前台应用: com.android.chrome (上次: com.timebank.app)
D/MonitorService: 检测到切换到新应用: com.android.chrome
D/MonitorService: 应用分类: Chrome - NEGATIVE
D/MonitorService: 负向应用，当前余额: 10
D/MonitorService: 同一应用 com.android.chrome 使用了 1 秒
D/MonitorService: 负向应用 Chrome 使用 1秒，扣除 1秒
(重复5次)
```

#### 预期界面：
- **不应弹出拦截界面**（因为余额充足）
- 余额减少约 5 秒（从 10 秒变为 5 秒）

---

### 测试 8: 边界测试 - 余额耗尽时拦截

#### 操作步骤：
1. 设置余额为 5 秒（通过使用正向应用获得）
2. 打开负向应用
3. 持续使用，观察第 5-6 秒时的情况

#### 预期：
- 使用 5 秒后，余额变为 0
- 继续使用第 6 秒时，弹出拦截界面

#### 预期日志：
```
(前5秒正常扣除)
D/MonitorService: 余额不足(当前: 0)，拦截负向应用: Chrome
```

---

## 问题诊断

### 如果监控服务启动闪退

#### 检查日志：
```bash
adb logcat | grep -E "FATAL|AndroidRuntime|SettingsScreen|MonitorService"
```

#### 查找：
- 是否有 `FATAL EXCEPTION` 错误
- 是否有权限被拒绝的提示

#### 可能原因：
1. Android 16 系统限制更严格
2. 前台服务权限未正确声明
3. 通知权限未授予

#### 解决方案：
- 检查系统设置 -> 应用 -> 时间银行 -> 权限
- 确保所有权限都已授予

---

### 如果拦截不生效

#### 检查清单：
1. [ ] 监控服务是否在运行？
   - 检查：通知栏是否有"时间银行正在运行"
   - 日志：是否有定期的"检查前台应用"日志

2. [ ] 应用是否已正确分类？
   - 检查："分类"页面，"负向应用"列表中是否有该应用
   - 日志：`应用分类: XXX - NEGATIVE`

3. [ ] 余额是否为 0？
   - 检查："设置"页面，"当前余额"是否为"0小时 0分钟"
   - 日志：`负向应用，当前余额: 0`

4. [ ] 是否看到拦截日志？
   - 日志：`余额不足，立即拦截负向应用: XXX`

5. [ ] 悬浮窗权限是否开启？
   - 检查：设置 -> 应用 -> 时间银行 -> 权限 -> 显示在其他应用上层

#### 详细日志分析：

**如果没有看到"检查前台应用"日志**:
- 说明服务未运行或被杀掉
- 解决：重启服务，检查电池优化设置

**如果看到"检查前台应用"但没有"检测到切换到新应用"**:
- 说明 `getForegroundApp()` 没有返回负向应用的包名
- 可能原因：包名不匹配
- 解决：查看日志中显示的实际包名，重新添加分类

**如果看到"应用分类: null"**:
- 说明应用未分类或分类失败
- 解决：在"分类"页面重新添加

**如果看到"负向应用，当前余额: XXX"但XXX > 0**:
- 说明余额不是 0
- 解决：点击"重置余额"

**如果看到"余额不足，立即拦截"但界面没弹出**:
- 说明悬浮窗权限未开启或Intent启动失败
- 解决：检查悬浮窗权限，查看是否有相关错误日志

---

### 如果应用列表为空或显示"所有应用已分类"

#### 检查日志：
```bash
adb logcat -s ClassifyViewModel
```

#### 查找：
```
D/ClassifyViewModel: 已加载 XXX 个应用
D/ClassifyViewModel: 未分类应用数量: XXX
```

#### 如果"已加载 0 个应用"：
- 说明 `getInstalledUserApps()` 返回空
- 可能原因：QUERY_ALL_PACKAGES 权限未生效
- 解决：重新安装 APK，确保权限声明正确

#### 如果"已加载 XXX 个"但"未分类应用数量: 0"：
- 说明所有应用都在已分类列表中（不太可能）
- 或者 combine 逻辑有问题
- 解决：查看"正向应用"和"负向应用"列表，是否真的有那么多

---

## 导出完整测试日志

如果问题仍然存在，请执行以下操作并提供日志文件：

```bash
# 清除旧日志
adb logcat -c

# 开始记录日志
adb logcat > timebank-full-test.log

# 然后执行完整测试流程：
# 1. 打开App
# 2. 配置权限
# 3. 添加应用分类
# 4. 开启监控服务
# 5. 测试拦截功能
# 6. (所有问题都出现时) 停止日志记录

# 停止日志记录：Ctrl+C

# 发送 timebank-full-test.log 文件
```

---

## 核心修改代码说明

### MonitorService.kt - checkCurrentApp()

```kotlin
private suspend fun checkCurrentApp() {
    val currentApp = usageStatsHelper.getForegroundApp()
    val currentTime = System.currentTimeMillis()

    // 新增：详细日志
    Log.d("MonitorService", "检查前台应用: $currentApp (上次: $lastApp)")

    if (currentApp != null && currentApp != packageName) {
        if (currentApp != lastApp) {
            Log.d("MonitorService", "检测到切换到新应用: $currentApp")

            val classification = appClassificationRepository.getAppByPackageName(currentApp)
            Log.d("MonitorService", "应用分类: ${classification?.appName} - ${classification?.category}")

            if (classification != null && classification.category == AppCategory.NEGATIVE) {
                val currentBalance = configRepository.getCurrentBalance().first()
                Log.d("MonitorService", "负向应用，当前余额: $currentBalance")

                if (currentBalance <= 0) {
                    Log.d("MonitorService", "余额不足，立即拦截负向应用: ${classification.appName}")
                    launchBlockActivity(classification.appName, currentApp)
                    // 关键：不更新lastApp和lastCheckTime，持续拦截
                    return
                }
            }

            lastApp = currentApp
            lastCheckTime = currentTime
        } else {
            // 计算使用时长
            val duration = (currentTime - lastCheckTime) / 1000
            if (duration >= 1) {
                Log.d("MonitorService", "同一应用 $currentApp 使用了 $duration 秒")
                handleAppUsage(currentApp, duration)
                lastCheckTime = currentTime
            }
        }
    }
}
```

### MainActivity.kt - SettingsScreen Switch

```kotlin
Switch(
    checked = monitorEnabled,
    onCheckedChange = { enabled ->
        val intent = Intent(context, MonitorService::class.java)
        try {
            if (enabled) {
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    context.startForegroundService(intent)
                } else {
                    context.startService(intent)
                }
                Log.d("SettingsScreen", "启动监控服务")

                // 关键：延迟更新状态，避免中断服务启动
                coroutineScope.launch {
                    delay(100)
                    viewModel.toggleMonitor(true)
                }
            } else {
                context.stopService(intent)
                Log.d("SettingsScreen", "停止监控服务")
                viewModel.toggleMonitor(false)
            }
        } catch (e: Exception) {
            Log.e("SettingsScreen", "服务操作失败: ${e.message}", e)
        }
    }
)
```

---

**维护者**: Claude Code
**更新时间**: 2026-01-06 11:30
**版本**: v1.2 (第三次修复)
