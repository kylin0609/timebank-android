# 时间银行 - 修复说明

**生成时间**: 2026-01-06
**APK 文件**: `app/build/outputs/apk/debug/app-debug.apk`
**文件大小**: 12MB

## 修复的问题

### 1. 设置页面闪退问题 ✅

**问题原因**: 使用 LaunchedEffect 监听 monitorEnabled 状态变化时，会在每次状态改变后重新组合，导致服务启动/停止被重复调用。

**解决方案**:
- 移除了 LaunchedEffect 代码块
- 将服务启动/停止逻辑直接移到 Switch 的 onCheckedChange 回调中
- 确保服务只在用户操作时启动/停止一次

**修改文件**: `MainActivity.kt` (SettingsScreen 函数，第 401-419 行)

### 2. 监控服务闪退问题 ✅

**问题原因**: MonitorService 中使用 `Class.forName("com.timebank.app.BlockActivity")` 来获取 BlockActivity 类引用，这种反射方式可能因为类加载失败而崩溃。

**解决方案**:
- 添加 BlockActivity 的 import 语句
- 直接使用 `BlockActivity::class.java` 来获取类引用
- 增强 Intent 标志位，确保 BlockActivity 能正确显示

**修改文件**:
- `service/MonitorService.kt` (导入和 launchBlockActivity 函数)
- `AndroidManifest.xml` (添加 showWhenLocked 和 turnScreenOn 属性)

### 3. 应用拦截不生效问题 ✅

**问题原因**:
- 缺少 SYSTEM_ALERT_WINDOW 悬浮窗权限
- 用户无法看到权限请求提示

**解决方案**:
- 在主页添加悬浮窗权限检查
- 显示清晰的权限状态提示（使用情况访问权限、悬浮窗权限）
- 添加"开启悬浮窗权限"按钮，直接跳转到系统权限设置
- 使用 LaunchedEffect 每秒检查权限状态，当用户从设置返回时自动更新
- 只有当两个权限都开启时，才显示"所有权限已开启"提示

**修改文件**:
- `MainActivity.kt` (HomeScreen 函数，第 130-313 行)
- `build.gradle.kts` (添加 lifecycle-runtime-compose 依赖)

### 4. BlockActivity 优化 ✅

**优化内容**:
- 添加 android:showWhenLocked="true" 确保锁屏时也能显示
- 添加 android:turnScreenOn="true" 确保能唤醒屏幕
- 添加 Intent.FLAG_ACTIVITY_NO_HISTORY 确保不保留在返回栈
- 添加 Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS 确保不出现在最近任务

**修改文件**:
- `AndroidManifest.xml` (BlockActivity 配置)
- `service/MonitorService.kt` (launchBlockActivity 函数)

## 功能特性

### 已实现的核心功能

1. **应用分类管理**
   - 正向应用（学习、阅读类）
   - 负向应用（娱乐、游戏类）
   - 未分类应用列表
   - 应用搜索功能（按名称或包名）
   - 应用图标显示

2. **时间余额系统**
   - 使用正向应用获得时间（duration * exchangeRatio）
   - 使用负向应用消耗时间（duration）
   - 兑换比例可调（0.1 - 2.0）
   - 余额不足时自动拦截负向应用

3. **后台监控服务**
   - 前台服务，确保持续运行
   - 每秒检查当前前台应用
   - 实时计算时间余额
   - 通知显示监控状态

4. **应用拦截界面**
   - 全屏警告界面
   - 显示当前余额
   - 提示如何获得时间
   - 锁屏和唤醒屏幕支持

5. **权限管理**
   - 使用情况访问权限（PACKAGE_USAGE_STATS）
   - 悬浮窗权限（SYSTEM_ALERT_WINDOW）
   - 查询所有应用权限（QUERY_ALL_PACKAGES）
   - 清晰的权限状态提示

6. **设置页面**
   - 查看当前余额和兑换比例
   - 调整兑换比例（滑块操作）
   - 开关监控服务
   - 重置余额
   - 清除所有数据

## 使用说明

### 1. 安装 APK
```bash
adb install app/build/outputs/apk/debug/app-debug.apk
```

### 2. 首次使用流程

1. **开启使用情况访问权限**
   - 点击"开启使用情况访问权限"按钮
   - 在系统设置中找到"时间银行"并开启权限
   - 返回应用

2. **开启悬浮窗权限**
   - 点击"开启悬浮窗权限"按钮
   - 在系统设置中允许"时间银行"显示悬浮窗
   - 返回应用

3. **分类应用**
   - 切换到"分类"标签
   - 在"未分类"列表中找到应用
   - 点击"正向"或"负向"按钮进行分类
   - 支持搜索功能快速查找应用

4. **设置兑换比例**
   - 切换到"设置"标签
   - 点击"兑换比例设置"卡片
   - 使用滑块调整比例（0.1 - 2.0）
   - 点击"确认"保存

5. **开启监控服务**
   - 在"设置"页面
   - 打开"后台监控服务"开关
   - 通知栏会显示"时间银行正在运行"

### 3. 运行机制

- **使用正向应用**: 每秒自动累加时间余额（秒数 × 兑换比例）
- **使用负向应用**: 每秒自动扣除时间余额
- **余额不足**: 自动弹出全屏拦截界面，无法继续使用负向应用
- **获得时间**: 使用正向应用即可获得时间，继续使用负向应用

## 技术架构

- **架构模式**: MVVM + Clean Architecture
- **UI 框架**: Jetpack Compose + Material Design 3
- **依赖注入**: Hilt/Dagger
- **数据持久化**: Room Database + DataStore
- **并发**: Kotlin Coroutines + Flow
- **权限**: UsageStatsManager + OverlayPermission

## 已知限制

1. **监控精度**: 每秒检查一次前台应用，可能存在 1 秒误差
2. **电池优化**: 部分设备可能会限制后台服务运行，需要在系统设置中关闭电池优化
3. **多任务切换**: 快速切换应用时可能有短暂延迟
4. **系统应用**: 无法拦截系统应用（如设置、桌面等）

## 调试日志

所有关键操作都会输出 Android Log：
- MonitorService: 监控服务状态和时间计算
- ClassifyScreen: 应用分类操作
- SettingsScreen: 设置修改操作

使用以下命令查看日志：
```bash
adb logcat -s MonitorService ClassifyScreen SettingsScreen
```

## 文件清单

### 核心文件
- `MainActivity.kt` - 主界面和设置页面
- `BlockActivity.kt` - 拦截界面
- `service/MonitorService.kt` - 后台监控服务
- `presentation/ui/classify/ClassifyScreen.kt` - 分类管理界面
- `presentation/viewmodel/SettingsViewModel.kt` - 设置页面逻辑

### 配置文件
- `AndroidManifest.xml` - 应用配置和权限声明
- `build.gradle.kts` - 依赖配置

## 下一步优化建议

1. **数据统计**: 添加每日使用统计和图表
2. **通知优化**: 显示当前余额和实时消耗速度
3. **白名单**: 支持设置免监控应用（如电话、短信）
4. **时间段控制**: 支持设置不同时间段的兑换比例
5. **导出数据**: 支持导出使用记录为 CSV 或 JSON

---

**维护者**: Claude Code
**最后更新**: 2026-01-06
